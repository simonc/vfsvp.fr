


<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <title>Tri de dépendances en Ruby avec TSort · VF svp</title>
    <meta name="author" content="Simon Courtois (@simonc)" />
    <meta name="description" content="" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="canonical" href="
  http://vfsvp.fr/article/dependency-sorting-in-ruby-with-tsort
" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/stylesheets/style.css" media="screen" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <link rel="alternate" href="/atom.xml" title="VF svp" type="application/atom+xml" />

    <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  </head>

  <body>
    <div class="navbar navbar-default navbar-static-top">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#menu">
        <span class="sr-only">Voir la navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">VFsvp</a>
    </div>
    <div id="menu" class="collapse navbar-collapse navbar-right">
      <ul class="main-nav nav nav-pills">
        <li><a href="/">Blog</a></li>
        <li><a href="/blog/archives">Archives</a></li>
        <li>
          <a href="/atom.xml" rel="subscribe-rss" title="Suivre via RSS">
            <i class="fa fa-rss"></i> RSS
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>


    <div class="container">
      <div class="row">
        <div class="col-sm-9">
          
<article class="article" role="article">
  <div class="row">
    <div class="col-sm-2">
      <p class="article-date">
        
          <span class="day">27/03</span>
          <span class="year">2014</span>
        
      </p>
      <p class="article-comments-count">
        <a href="#" title="Commentaires">0</a>
        <i class="fa fa-comment"></i>
      </p>
    </div>
    <div class="col-sm-10 article-body">
      <header>
        
          <h1 class="article-title">Tri de dépendances en Ruby avec TSort</h1>
          <div class="sharing">
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://vfsvp.fr/article/dependency-sorting-in-ruby-with-tsort" data-via="VFsvp" data-counturl="http://vfsvp.fr/article/dependency-sorting-in-ruby-with-tsort" >Tweet</a>
  <div class="g-plusone" data-size="medium" data-href="http://vfsvp.fr/article/dependency-sorting-in-ruby-with-tsort"></div>
</div>

        
      </header>

      
        <div class="article-content"><p>Source: <a href="http://viget.com/extend/dependency-sorting-in-ruby-with-tsort">Dependency Sorting in Ruby with TSort de Lawson Kurtz sur le blog de Viget</a></p>

<p>Si vous utilisez Ruby, vous avez probablement eu l&#8217;occasion d&#8217;expérimenter les
miracles de la gestion de dépendances de <a href="http://bundler.io/"><em lang="en">Bundler</em></a>.
Ce que vous ne savez peut-être pas, c&#8217;est que vous pouvez utiliser les mêmes
mécanismes de tri de dépendances dans vos propres applications et dans d&#8217;autres
contextes.</p>

<!-- more -->


<h2 id="hello-tsort">Hello TSort</h2>

<p><a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/tsort/rdoc/TSort.html"><em lang="en">TSort</em></a>
est un module Ruby, disponible dans la bibliothèque standard, qui permet de
faire du <a href="http://fr.wikipedia.org/wiki/Tri_topologique">tri topologique</a>.
<em lang="en">Bundler</em> utilise <em lang="en">TSort</em> pour démêler le sac de nœuds de dépendances
de vos <em lang="en">gems</em>. La gestion de ces dépendances est la partie émergée de
l&#8217;iceberg en ce qui concerne les possibilités du tri topologique. Il est assez
facile de profiter de l&#8217;incroyable puissance de <em lang="en">TSort</em> dans votre projet.</p>

<h2 id="use-case-ajouter-des-donnees-dexemple-dans-un-base-de-donnees">Use Case : Ajouter des données d&#8217;exemple dans un base de données</h2>

<p>Imaginons une tâche qui doit peupler une base de données avec plusieurs
enregistrements. Mais rien n&#8217;est jamais facile, nos enregistrements ont des
dépendances comme le montre l&#8217;exemple ci-dessous :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><pre><code class='ruby'><span class='line'><span class="n">user_1</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span> <span class="ss">address</span><span class="p">:</span> <span class="n">address_1</span>
</span><span class='line'>
</span><span class='line'><span class="n">school_1</span> <span class="o">=</span> <span class="no">School</span><span class="o">.</span><span class="n">create</span> <span class="ss">address</span><span class="p">:</span> <span class="n">address_2</span><span class="p">,</span> <span class="ss">faculty</span><span class="p">:</span> <span class="o">[</span><span class="n">user_1</span><span class="o">]</span>
</span><span class='line'><span class="n">school_2</span> <span class="o">=</span> <span class="no">School</span><span class="o">.</span><span class="n">create</span> <span class="ss">address</span><span class="p">:</span> <span class="n">address_3</span>
</span><span class='line'>
</span><span class='line'><span class="n">address_1</span> <span class="o">=</span> <span class="no">Address</span><span class="o">.</span><span class="n">create</span> <span class="n">zip_code</span><span class="p">:</span> <span class="n">zip_code_1</span>
</span><span class='line'><span class="n">address_2</span> <span class="o">=</span> <span class="no">Address</span><span class="o">.</span><span class="n">create</span> <span class="n">zip_code</span><span class="p">:</span> <span class="n">zip_code_2</span>
</span><span class='line'><span class="n">address_3</span> <span class="o">=</span> <span class="no">Address</span><span class="o">.</span><span class="n">create</span> <span class="n">zip_code</span><span class="p">:</span> <span class="n">zip_code_2</span>
</span><span class='line'>
</span><span class='line'><span class="n">zip_code_1</span> <span class="o">=</span> <span class="no">ZipCode</span><span class="o">.</span><span class="n">create</span>
</span><span class='line'><span class="n">zip_code_2</span> <span class="o">=</span> <span class="no">ZipCode</span><span class="o">.</span><span class="n">create</span>
</span></code></pre></div></figure>


<h3 id="le-probleme">Le problème</h3>

<p>Si on lance le pseudo-code précédent, il va bien sûr lever une exception
<code>NameError</code> puisque plusieurs enregistrements en référencent d&#8217;autres qui ne
sont pas encore créés.</p>

<p>Pour cet exemple simpliste, il serait facile de trier les lignes à la main, pour
que les insertions aient lieu dans le bon ordre. Mais comment faire quand les
relations dépendantes sont plus complexes ou quand le nombre d&#8217;enregistrements
est tout simplement trop important ? Trier à la main n&#8217;est simplement pas
envisageable (qui aime faire les choses à la main de toute façon ?).</p>

<h3 id="la-solution">La solution</h3>

<p>C&#8217;est ici que <em lang="en">TSort</em> entre en scène. Nous pouvons l&#8217;utiliser pour
déterminer l&#8217;ordre dans lequel ces enregistrements doivent être insérés.</p>

<p>La façon la plus rapide d&#8217;utiliser <em lang="en">TSort</em> est de créer puis trier un
<em lang="en">hash</em> dans lequel chaque clé représente un objet et chaque valeur est un
tableau de références aux objets dont l&#8217;objet-clé dépend.</p>

<p>Si <code>skier</code> dépend de <code>neige</code> et <code>neige</code> dépend de <code>nuages</code> et <code>froid</code>, notre
<em lang="en">hash</em> va ressembler à ceci :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><pre><code class='ruby'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s1">&#39;nuages&#39;</span> <span class="o">=&gt;</span> <span class="o">[]</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;froid&#39;</span>  <span class="o">=&gt;</span> <span class="o">[]</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;skier&#39;</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;neige&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;neige&#39;</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;nuages&#39;</span><span class="p">,</span> <span class="s1">&#39;froid&#39;</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></div></figure>


<p>Nous listons seulement les dépendances de premier niveau, <em lang="en">TSort</em> se
débrouillera tout seul pour déterminer le reste.</p>

<p>Pour faire un tri topologique sur ce <em lang="en">hash</em> de dépendances, il nous faut
quelques fonctionnalités de <em lang="en">TSort</em>. Le plus simple est de créer une classe
qui hérite de <em lang="en">Hash</em> comme ceci :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;tsort&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TsortableHash</span> <span class="o">&lt;</span> <span class="no">Hash</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TSort</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">alias</span> <span class="n">tsort_each_node</span> <span class="n">each_key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tsort_each_child</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fetch</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></div></figure>


<p>Nous pouvons maintenant utiliser notre classe pour construire le <em lang="en">hash</em> de
dépendances. Pour nos enregistrements du début, il va ressembler à ceci :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><pre><code class='ruby'><span class='line'><span class="n">dependency_hash</span> <span class="o">=</span> <span class="p">\</span>
</span><span class='line'><span class="no">TsortableHash</span><span class="o">[</span>
</span><span class='line'>  <span class="n">user_1</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="n">address_1</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">school_1</span>   <span class="o">=&gt;</span> <span class="o">[</span><span class="n">address_2</span><span class="p">,</span> <span class="n">user_1</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">school_2</span>   <span class="o">=&gt;</span> <span class="o">[</span><span class="n">address_3</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">address_1</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="n">zip_code_1</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">address_2</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="n">zip_code_2</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">address_3</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="n">zip_code_2</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">zip_code_1</span> <span class="o">=&gt;</span> <span class="o">[]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">zip_code_2</span> <span class="o">=&gt;</span> <span class="o">[]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></div></figure>


<p>Une fois notre <em lang="en">hash</em> de dépendances <em lang="en">tsortable</em> créé, le plus dur
est fait. <em lang="en">TSort</em> s&#8217;occupe du reste et nous donne un tableau ordonné qu&#8217;il
nous suffit de suivre pour insérer les enregistrements sans problème.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><pre><code class='ruby'><span class='line'><span class="n">dependency_hash</span><span class="o">.</span><span class="n">tsort</span>
</span><span class='line'><span class="c1">#=&gt; [zip_code_1, address_1, user_1, zip_code_2, address_2, school_1, address_3, school_2]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Si vous avez des dépendances circulaires, #tsort lèvera une exception TSort::Cyclic.</span>
</span></code></pre></div></figure>


<p><em lang="en">TSort</em> est un outil incroyablement puissant et simple pour ordonner des
relations dépendantes. La prochaine fois que vous avez du mal à gérer des
dépendances, rassurez-vous,
<a href="http://ruby-doc.org/stdlib-2.0.0/libdoc/tsort/rdoc/TSort.html">TSort</a> est
disponible en un clic.</p>
</div>

        <footer>
          <p class="meta">
            
  

<span class="byline author vcard">Posted by <span class="fn">Simon Courtois (simonc)</span></span>

            








  



  

<time datetime="2014-03-27T16:00:00+01:00" pubdate data-updated="true">27/03/2014</time>
            

<span class="categories">
  
    <a class='category' href='/tags/ruby/'>ruby</a>
  
</span>


          </p>
          <p class="meta">
            
              <a class="basic-alignment left" href="/article/une-introduction-en-profondeur-a-emberjs" title="Previous Post: Une introduction en profondeur à Ember.js">&laquo; Une introduction en profondeur à Ember.js</a>
            
            
              <a class="basic-alignment right" href="/article/gem-universelle-en-20-lignes" title="Next Post: Une gem Ruby universelle en 20 lignes de code">Une gem Ruby universelle en 20 lignes de code &raquo;</a>
            
          </p>
        </footer>

        <section>
          <h1>Commentaires</h1>
          <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        </section>
      
    </div>
  </div>
</article>


        </div>

        <aside class="sidebar col-sm-3">
          <section>
  <h1>VF svp</h1>
  <p>VF svp est un projet communautaire de traduction d'articles techniques.
    Pour proposer une traduction, rendez-vous sur
    <a href="http://github.com/simonc/vfsvp.fr" title="Page Github du projet VF svp">le Github du projet</a>.</p>
</section>
<section>
  <h1>Recherche</h1>
  <form role="search" action="http://google.com/search" method="get">
    <div class="form-group">
      <input type="hidden" name="q" value="site:vfsvp.fr" />
      <input type="text" name="q" results="0" class="form-control" placeholder="Rechercher..." />
    </div>
  </form>
</section>

<section>
  <h1>Twitter</h1>
  <p><a href="https://twitter.com/VFsvp">@VFsvp</a> sur Twitter</p>
</section>

<section>
  <h1>Sponsors</h1>
  <p>
    <a href="http://www.tinci.fr"><img src="/images/sponsors/tinci.png" alt="Tinci" /></a>
  </p>
</section>

        </aside>
      </div>
    </div>

    <footer class="text-center">
      <footer role="contentinfo">
  <p>Copyright © 2014 - Simon Courtois (@simonc) -
    <span class="credit">Publié grâce à
    <a href="http://octopress.org">Octopress</a></span></p>
</footer>

    </footer>
    <script type="text/javascript">
  var disqus_shortname = 'vfsvp';

  
    var disqus_identifier = 'http://vfsvp.fr/article/dependency-sorting-in-ruby-with-tsort';
    var disqus_url = 'http://vfsvp.fr/article/dependency-sorting-in-ruby-with-tsort';
    var disqus_script = 'embed.js';
  

  (function () {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-15419839-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.1.0.1/js/bootstrap.min.js"></script>

  </body>
</html>
